<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ü–µ–Ω–∫–∞ –¥–Ω—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #ffffff;
      margin: 0;
      padding: 20px;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .rating-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      max-width: 400px;
      height: 60px;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
    }
    .save-btn {
      background-color: #007bff;
      color: white;
    }
    .message {
      margin-top: 20px;
      font-weight: bold;
      color: green;
    }
    .calendar {
      width: 100%;
      max-width: 600px;
      margin-top: 40px;
    }
    .month {
      margin-bottom: 20px;
    }
    .month h3 {
      margin: 10px 0;
      text-align: left;
    }
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .day {
      width: 100%;
      padding-top: 100%;
      position: relative;
      background-color: #eee;
      border-radius: 4px;
      cursor: pointer;
    }
    .day[data-color]::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 4px;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>–ö–∞–∫ –ø—Ä–æ—à—ë–ª —Ç–≤–æ–π –¥–µ–Ω—å?</h1>
  <div class="rating-buttons">
    <button onclick="selectRating('üü¢ –û—Ç–ª–∏—á–Ω—ã–π')">üü¢</button>
    <button onclick="selectRating('üü° –•–æ—Ä–æ—à–∏–π')">üü°</button>
    <button onclick="selectRating('‚ö™Ô∏è –û–±—ã—á–Ω—ã–π')">‚ö™Ô∏è</button>
    <button onclick="selectRating('üî¥ –ü–ª–æ—Ö–æ–π')">üî¥</button>
    <button onclick="selectRating('‚ö´Ô∏è –£–∂–∞—Å–Ω—ã–π')">‚ö´Ô∏è</button>
  </div>

  <textarea id="good" placeholder="–ß—Ç–æ –±—ã–ª–æ —Ö–æ—Ä–æ—à–æ?"></textarea>
  <textarea id="bad" placeholder="–ß—Ç–æ –±—ã–ª–æ –ø–ª–æ—Ö–æ?"></textarea>
  <textarea id="improve" placeholder="–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?"></textarea>

  <button class="save-btn" onclick="saveDay()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>

  <div class="message" id="message"></div>

  <div class="calendar" id="calendar"></div>

  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content" id="modal-content"></div>
  </div>

  <script>
    let rating = null;
    const tg = window.Telegram.WebApp;
    tg.expand();

    function selectRating(value) {
      rating = value;
      document.getElementById('message').textContent = `–û—Ü–µ–Ω–∫–∞ –≤—ã–±—Ä–∞–Ω–∞: ${value}`;
    }

    function getRandomMessage() {
      const messages = [
        '–ö—Ä–∞—Å–∞–≤—á–∏–∫! üëè',
        '–ì–ª–∞–≤–Ω–æ–µ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, –∞ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç—å üí™',
        '–¢—ã —É–∂–µ –ª—É—á—à–µ, —á–µ–º –±—ã–ª –≤—á–µ—Ä–∞ ‚ú®',
        '–û—Ç–º–µ—Ç–∏–ª ‚Äî –ø–æ–±–µ–¥–∏–ª!',
        '–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ ‚Äî –±–æ–ª—å—à–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è üö∂‚Äç‚ôÇÔ∏è',
        '–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
        '–¢—ã –º–æ–ª–æ–¥–µ—Ü, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–µ–Ω—å –±—ã–ª –Ω–µ –∏–¥–µ–∞–ª–µ–Ω.',
        '–ó–∞–º–µ—Ç–∏—Ç—å ‚Äî –∑–Ω–∞—á–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å.',
        '–¢—ã —Å —Å–æ–±–æ–π –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ. –≠—Ç–æ –≥–ª–∞–≤–Ω–æ–µ.'
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    }

    function saveDay() {
      const good = document.getElementById('good').value;
      const bad = document.getElementById('bad').value;
      const improve = document.getElementById('improve').value;

      if (!rating) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –æ—Ü–µ–Ω–∫—É –¥–Ω—è.');
        return;
      }

      const entry = {
        user_id: tg.initDataUnsafe.user?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
        rating,
        good,
        bad,
        improve
      };

      fetch('https://script.google.com/a/macros/antago.org/s/AKfycbxlgjROW1RtrAX5qebKDG_3Pi81FgRhocfDdfzWu5GhPBRBl5NkAX6YfiOp5NB4zOfz7A/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(entry)
      });

      const message = getRandomMessage();
      document.getElementById('message').textContent = '–î–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ' + message;

      document.getElementById('good').value = '';
      document.getElementById('bad').value = '';
      document.getElementById('improve').value = '';
      rating = null;
    }

    const colorMap = {
      'üü¢': '#4caf50',
      'üü°': '#ffeb3b',
      '‚ö™Ô∏è': '#e0e0e0',
      'üî¥': '#f44336',
      '‚ö´Ô∏è': '#212121'
    };

    async function renderYearCalendar() {
      const container = document.getElementById('calendar');
      const userId = tg.initDataUnsafe.user?.id || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const url = `https://script.google.com/macros/s/AKfycbwaC2YvkmL3LSyPaywmHC-5V0LZbuXZ0bTy0Td-fEsazHo4eKlUtaeP329BT90WImL_Gg/exec?user_id=${userId}`;

      const res = await fetch(url);
      const data = await res.json();
      const months = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

      for (let m = 0; m < 12; m++) {
        const month = document.createElement('div');
        month.className = 'month';

        const title = document.createElement('h3');
        title.textContent = months[m];
        month.appendChild(title);

        const grid = document.createElement('div');
        grid.className = 'days';

        const daysInMonth = new Date(2025, m + 1, 0).getDate();
        const firstDay = new Date(2025, m, 1).getDay();
        const shift = firstDay === 0 ? 6 : firstDay - 1;

        for (let i = 0; i < shift; i++) {
          const empty = document.createElement('div');
          empty.className = 'day';
          grid.appendChild(empty);
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `2025-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const cell = document.createElement('div');
          cell.className = 'day';

          if (data[dateStr]) {
            const color = colorMap[data[dateStr].rating];
            cell.style.backgroundColor = color;
            cell.onclick = () => showModal(dateStr, data[dateStr]);
          }

          grid.appendChild(cell);
        }

        month.appendChild(grid);
        container.appendChild(month);
      }
    }

    function showModal(date, info) {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');

      content.innerHTML = `<h3>${date}</h3>
        <p><b>–û—Ü–µ–Ω–∫–∞:</b> ${info.rating}</p>
        <p><b>–•–æ—Ä–æ—à–µ–µ:</b> ${info.good || '-'}</p>
        <p><b>–ü–ª–æ—Ö–æ–µ:</b> ${info.bad || '-'}</p>
        <p><b>–£–ª—É—á—à–∏—Ç—å:</b> ${info.improve || '-'}</p>
        <button onclick="document.getElementById('modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>`;

      modal.style.display = 'flex';
    }

    renderYearCalendar();
  </script>
</body>
</html>
